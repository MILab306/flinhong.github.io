rangy.createModule("SaveRestore",function(c,a){function i(h,j){var l="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),n,k=f.getDocument(h.startContainer),m=h.cloneRange();m.collapse(j);n=k.createElement("span");n.id=l;n.style.lineHeight="0";n.style.display="none";n.className="rangySelectionBoundary";n.appendChild(k.createTextNode(e));m.insertNode(n);m.detach();return n;}function g(h,j,k,l){if(h=(h||document).getElementById(k)){j[l?"setStartBefore":"setEndBefore"](h);h.parentNode.removeChild(h);}else{a.warn("Marker element has been removed. Cannot restore selection.");}}function d(h,j){return j.compareBoundaryPoints(h.START_TO_START,h);}function b(h,j){var k=(h||document).getElementById(j);k&&k.parentNode.removeChild(k);}c.requireModules(["DomUtil","DomRange","WrappedRange"]);var f=c.dom,e="\ufeff";c.saveSelection=function(r){r=r||window;var l=r.document;if(c.isSelectionValid(r)){var n=c.getSelection(r),p=n.getAllRanges(),m=[],o,h;p.sort(d);for(var q=0,k=p.length;q<k;++q){o=p[q];if(o.collapsed){h=i(o,false);m.push({markerId:h.id,collapsed:true});}else{h=i(o,false);o=i(o,true);m[q]={startMarkerId:o.id,endMarkerId:h.id,collapsed:false,backwards:p.length==1&&n.isBackwards()};}}for(q=k-1;q>=0;--q){o=p[q];if(o.collapsed){o.collapseBefore((l||document).getElementById(m[q].markerId));}else{o.setEndBefore((l||document).getElementById(m[q].endMarkerId));o.setStartAfter((l||document).getElementById(m[q].startMarkerId));}}n.setRanges(p);return{win:r,doc:l,rangeInfos:m,restored:false};}else{a.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus.");}};c.restoreSelection=function(t,n){if(!t.restored){for(var p=t.rangeInfos,r=c.getSelection(t.win),o=[],q=p.length,k=q-1,s,m;k>=0;--k){s=p[k];m=c.createRange(t.doc);if(s.collapsed){if(s=(t.doc||document).getElementById(s.markerId)){s.style.display="inline";var h=s.previousSibling;if(h&&h.nodeType==3){s.parentNode.removeChild(s);m.collapseToPoint(h,h.length);}else{m.collapseBefore(s);s.parentNode.removeChild(s);}}else{a.warn("Marker element has been removed. Cannot restore selection.");}}else{g(t.doc,m,s.startMarkerId,true);g(t.doc,m,s.endMarkerId,false);}q==1&&m.normalizeBoundaries();o[k]=m;}if(q==1&&n&&c.features.selectionHasExtend&&p[0].backwards){r.removeAllRanges();r.addRange(o[0],true);}else{r.setRanges(o);}t.restored=true;}};c.removeMarkerElement=b;c.removeMarkers=function(h){for(var j=h.rangeInfos,l=0,m=j.length,k;l<m;++l){k=j[l];if(k.collapsed){b(h.doc,k.markerId);}else{b(h.doc,k.startMarkerId);b(h.doc,k.endMarkerId);}}};});